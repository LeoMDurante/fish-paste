```{r} 
rm(list = ls()) # clear workspace
library(tidyverse)

## LOAD: Site visit table from Oracle database that has sectors defined to each site (by Kisei)
raw<-read.csv("C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/Site visit tables/Cleaned_sitevisit_112322_SEC_NAME.csv") # 806 sites

# Only OCC sites with photoquads / SfM  (May want to eventually include all OCC sites into survey master- this will be a bigger lift)
raw_bf <- raw %>% filter(!(TYPE %in% c("Oceanography") & PHOTOMOSAIC_YN == "NO" & TRANSECT_PHOTOS == "NO")) # 593 sites

## QC
raw_bf %>% distinct(TYPE, PHOTOMOSAIC_YN, TRANSECT_PHOTOS, CB_ACTIVITY_YN, FISH_REA_YN) %>% arrange(TYPE)
raw_bf %>% filter(TYPE == "Fish" & FISH_REA_YN == "NO") # 5 sites (TYPE = Fish) with CTD/water samples but no Fish surveys?? 
raw_bf %>% filter(SITE %in% c("ROT-717", "ROT-742", "AGU-541", "AGU-549")) %>% distinct(SITE, TYPE, CTD_ACTIVITY_YN, H2O_ACTIVITY_YN, FISH_REA_YN)

raw_bf %>% filter(CB_ACTIVITY_YN == "YES") %>% distinct(TYPE)
raw_bf %>% filter(ASSOC_OCC_SITEID != "")
# carb budget fish surveys --> want all to have FISH_REA_YN = NO
raw_bf %>% filter(TYPE == "Fish" & CB_ACTIVITY_YN == "YES") 
raw_bf %>% filter(FISH_REA_YN == "YES" & CB_ACTIVITY_YN == "YES") # GUA-2587 needs to be fixed!

# check sector names assigned to sites
raw_bf %>% distinct(SEC_NAME)
raw_bf %>% filter(grepl("TUT_", SEC_NAME)) %>% distinct(TYPE) # 18 benthic sites from Tutuila (Samoa)
raw_bf %>% filter(grepl("TUT_", SEC_NAME)) %>% distinct(EXCLUDE_FLAG) # NOT currently excluded
raw_bf %>% filter(grepl("HAW_", SEC_NAME)) # 2 Fish sites from Kona, HI
raw_bf %>% filter(grepl("HAW_", SEC_NAME)) %>% distinct(EXCLUDE_FLAG) # GOOD TO GO --> excluded already

## FIX QC ISSUES
sv <- raw_bf %>% filter(!(TYPE == "Fish" & FISH_REA_YN == "NO")) %>% # REMOVE sites that are TYPE = Fish but are only water sampling (5 sites - see list above)
  filter(!(FISH_REA_YN == "YES" & CB_ACTIVITY_YN == "YES")) %>% # REMOVE 1 CB site (not Fish REA or benthic PQ/SfM) --> CHECK if there's a way to indicate the fish surveys but indicate they're non-NCRMP w/ EXCLUDE_FLAG column
  mutate(EXCLUDE_FLAG = ifelse(grepl("TUT_", SEC_NAME), "YES", EXCLUDE_FLAG)) # indicate EXCLUDE for Samoa mission (non-NCRMP)

## CLEANUP
colnames(sv)[colnames(sv)=="MAX_DEPTH_M"]<-"new_MAX_DEPTH_M"
colnames(sv)[colnames(sv)=="MIN_DEPTH_M"]<-"new_MIN_DEPTH_M"
colnames(sv)[colnames(sv)=="LONGITUDE_LOS"]<-"LONGITUDE_LOV"
colnames(sv)[colnames(sv)=="LATITUDE_LOS"]<-"LATITUDE_LOV"
colnames(sv)[colnames(sv)=="MICROBIAL_YN"]<-"microb"
colnames(sv)[colnames(sv)=="CAUS_DEPLOY_YN"]<-"cau_d"
colnames(sv)[colnames(sv)=="CAUS_RETRIEVE_YN"]<-"cau_r"

## INDICATORS OF SITE TYPE
sv.final <- sv %>% mutate(Benthic = ifelse(TYPE == "Benthic", 1, 0)) %>% 
  mutate(Fish = ifelse(TYPE == "Fish" & FISH_REA_YN == "YES", 1, 0)) %>%
  mutate(Oceanography = ifelse(TYPE == "Oceanography", 1, 0)) %>%
  mutate(CAU = ifelse(cau_r== "YES", 1, 0))
 
write.csv(sv.final, "C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/Site visit tables/12072022_cleaned_sitevisit_CC_SEC_NAME_KT_prep_TK.csv")
```

## SECTOR ASSIGNMENTS SHOULD BE QCed BY BENTHIC & FISH 
# ArcGIS: (1) load sitevisit file and plot lat/longs per site onto map (color code by depth bin); filter so only plotting fish sites!
#         (2) check sector assignments w/ sector & reef zone shapefiles: https://docs.google.com/spreadsheets/d/1ubvirPEe6gf9Ub-KEIw9bThGtvlkvzY5_09mdaUtlQo/edit?pli=1#gid=0
#         (3) compare numbers per sector-reef zone-depth bin with targeted allocation & determine sector assignments to sites on the edge of 2 sectors, etc.

## UPDATE SITEVISIT BASED ON QC
```{r} 
rm(list = ls()) # clear workspace
library(tidyverse)

## MARIANAS 2022 QC: all sector assignments look good & all sites fall into forereef areas; no reassignments needed

sv.final <- read.csv("C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/Site visit tables/12072022_cleaned_sitevisit_CC_SEC_NAME_KT_prep_TK.csv") # 587 sites
sv.fish <- sv.final %>% filter(Fish == 1) # FISH SITES ONLY --> 322 sites

# Specify EXTRA sites surveyed specifically for Guam MPA project inside Piti Bomb --> EXCLUDE_FLAG = YES ; otherwise, influence of Piti in Guam MP sector (all MPAs typically pooled per year) will be off/greater than in other years
Gmpa <- read.csv("C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/Site visit tables/GuamMPAProject_PitiAsan_NCRMP_site_table.csv") # load GuamMPA project site indicator from Kaylyn
# FIX QC issues
Gmpa.qc <- Gmpa %>% filter(SITE != "GUA-026")  # remove 1 extra site --> erroneous
  
# merge with SITEVISIT
sv.QC <- sv.fish %>% left_join(Gmpa.qc %>% select(SITEVISITID, SEC_NAME, ANALYSIS_SCHEME, starts_with("SPECIAL")) %>% dplyr::rename(SEC_MPA = SEC_NAME), by = c("SITEVISITID"))
sv.QC %>% select(SEC_NAME, SEC_MPA, ANALYSIS_SCHEME, starts_with("SPECIAL")) %>% distinct() %>% arrange(SEC_NAME)

# FIX QC issues
sv.clean <- sv.QC %>% 
  mutate(SEC_MPA = ifelse(SITEVISITID %in% c(38981, 39407, 39000), "GUA_ASAN", SEC_MPA)) %>% # sites missed by Kaylyn in Asan 
  mutate(ANALYSIS_SCHEME = ifelse(SEC_MPA == "GUA_ASAN", "NO SCHEME", ANALYSIS_SCHEME)) %>% # turn all Asan sites to NO SCHEME
  # indicate which sites in Asan to include as NCRMP 00> optimal target #s given we had more time in Guam due to ship delays
  mutate(ANALYSIS_SCHEME = ifelse(SITEVISITID %in% c(38480, 39103, 39084, 38482, 38483, 39002, 38981, 39727, 38481, 38484, 39432, 39434, 39060), "RAMP_BASIC", ANALYSIS_SCHEME)) %>% 
  
  mutate(SPECIAL_PROJ_YN = ifelse(SEC_NAME == "GUA_PITI_BOMB" | SEC_MPA == "GUA_ASAN", -1, 0)) %>% # indicate all sites in Piti & Asan --> use in GuamMPA project
  mutate(SPECIAL_PROJ_DESCRIPTION = ifelse(SEC_NAME == "GUA_PITI_BOMB" | SEC_MPA == "GUA_ASAN", "Guam_Piti_2022", NA)) %>% 
  mutate(ANALYSIS_SCHEME = ifelse(SEC_NAME == "GUA_PITI_BOMB" & is.na(ANALYSIS_SCHEME), "NO SCHEME", ANALYSIS_SCHEME)) %>% # sites missed by Kaylyn in Piti --> NO SCHEME (non-NCRMP sites)
  mutate(ANALYSIS_SCHEME = ifelse(SITEVISITID %in% c(39522, 39520), "RAMP_BASIC", ANALYSIS_SCHEME)) # 2 sites missed by Kaylyn in Piti --> NO SCHEME (non-NCRMP sites)

# check
sv.clean %>% select(SEC_NAME, SEC_MPA, ANALYSIS_SCHEME, starts_with("SPECIAL")) %>% distinct() %>% arrange(SEC_NAME)
  
# FINAL CLEANUP
sv.clean %>% select(SEC_NAME, ANALYSIS_SCHEME, starts_with("SPECIAL"), EXCLUDE_FLAG) %>% distinct() %>% arrange(SEC_NAME)


sv.qc.final <- sv.clean %>% select(-SEC_MPA) %>%
  # fill in remaining indicator values
  mutate(SPECIAL_PROJ_YN = ifelse(SEC_NAME == "HAW_KONA", -1, SPECIAL_PROJ_YN)) %>% # indicate all sites in 2022 HIMARC Calibration Weekend in Kona, HI (2 sites)
  mutate(SPECIAL_PROJ_DESCRIPTION = ifelse(SEC_NAME == "HAW_KONA", "HIMARC_CalibWknd_2022", SPECIAL_PROJ_DESCRIPTION)) %>% 
  mutate(ANALYSIS_SCHEME = ifelse(SEC_NAME == "HAW_KONA", "NO SCHEME", ANALYSIS_SCHEME)) %>% 
  # indicate exclusion of special project sites that aren't also part of NCRMP
  mutate(EXCLUDE_FLAG = ifelse(ANALYSIS_SCHEME %in% c("NO SCHEME"), -1, 0)) %>% # turn EXCLUDE_FLAG to -1 vs. 0 to be consistent with SURVEY MASTER (-1 = exclude)
  # fill in remaining NAs
  mutate(ANALYSIS_SCHEME = ifelse(is.na(ANALYSIS_SCHEME), "RAMP_BASIC", ANALYSIS_SCHEME)) %>%
  mutate(SPECIAL_PROJ_YN = ifelse(is.na(SPECIAL_PROJ_YN), 0, SPECIAL_PROJ_YN)) 
  
# REMERGE with benthic sites
sv.fishQC <- sv.qc.final %>% 
  bind_rows(sv.final %>% filter(Fish == 0) %>% # 265 benthic sites
              mutate(EXCLUDE_FLAG = ifelse(EXCLUDE_FLAG == "YES", -1, 0)) %>% # turn EXCLUDE_FLAG to -1 vs. 0 to be consistent with SURVEY MASTER (-1 = exclude)
              mutate(SPECIAL_PROJ_YN = ifelse(grepl("TUT_", SEC_NAME), -1, 0))) # update special project YN for TUT sites

sv.fishQC %>% distinct(SEC_NAME, SPECIAL_PROJ_DESCRIPTION, SPECIAL_PROJ_YN, EXCLUDE_FLAG)

## SAVE
write.csv(sv.fishQC, "C:/Users/tye.kindinger/Desktop/FISH TEAM/Post-cruise workings/2022_Marianas/Site visit tables/12082022_SITEVISIT_QC_TLK.csv")





# compare column names with those in SURVEYMASTER
sv.qc.final[,order(colnames(sv.qc.final))]  %>% names()

# OLD_SITE, OCC_SITEID, PERM_SITE, benth, fish, arms_d, arms_r, microb, ARMS, HUMANS20, HUMANS200, TYPE = RANDOM, FIXED, Haphazard, NA, BAD HABITAT, bANALYSIS_SCHEME, ANALYSIS_YEAR, TUT2012, OTHER_AREA_GROUPING

```